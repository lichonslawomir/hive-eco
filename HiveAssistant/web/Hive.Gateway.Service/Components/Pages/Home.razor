@page "/"
@using BeeHive.Contract.Aggregate.Models
@using BeeHive.Contract.Data.Models
@using BeeHive.Contract.Hives.Models
@using BeeHive.Domain.Aggregate
@using BeeHive.Domain.Data

@rendermode InteractiveServer

@inject IHiveService HiveService
@inject IScopeService ScopeService
@inject IAppState AppState

@implements IDisposable

<PageTitle>Home</PageTitle>
<PeriodSelector Period="period" StartDate="startDate" EndDate="endDate" OnLoadData="LoadAggregateData" ParamChanged="PeriodChanged"/>
<MainGraph Hives="_hives"
    TemperatureAggregateData="_temperatureAggregateData"
    HumidityAggregateData="_humidityAggregateData"
    TemperatureData="_temperatureData"
    HumidityData="_humidityData" />

@code {
    private IList<HiveDto> _hives = new List<HiveDto>();

    private IList<TimeAggregateSeriesHivesDataModel> _temperatureAggregateData = new List<TimeAggregateSeriesHivesDataModel>();
    private IList<TimeAggregateSeriesHivesDataModel> _humidityAggregateData = new List<TimeAggregateSeriesHivesDataModel>();

    private IList<(string name, TimeSeriesDataModel? data)> _temperatureData = new List<(string name, TimeSeriesDataModel? data)>();
    private IList<(string name, TimeSeriesDataModel? data)> _humidityData = new List<(string name, TimeSeriesDataModel? data)>();

    BeeHive.Domain.Aggregate.AggregationPeriod period = BeeHive.Domain.Aggregate.AggregationPeriod.Min5;
    private DateTimeOffset startDate = DateTimeOffset.Now.Date;
    private DateTimeOffset endDate = DateTimeOffset.Now.Date.AddDays(1).AddTicks(-1); // End of today

    protected override async Task OnInitializedAsync()
    {
        _hives = await HiveService.ListHives();

        AppState.OnGraphDataChange += HandleGraphDataChange;
        AppState.OnTimeSeriesAdded += HandleTimeSeriesAdded;
        await AppState.StartListeningAsync();
    }
    protected override async Task OnParametersSetAsync()
    {
        await LoadAggregateData(HiveService);
        await LoadLastData(HiveService);
        await AppState.StartListeningAsync();
    }
    public void Dispose()
    {
        AppState.OnGraphDataChange -= HandleGraphDataChange;
        AppState.OnTimeSeriesAdded -= HandleTimeSeriesAdded;
    }
    private Task PeriodChanged((AggregationPeriod period, DateTimeOffset startDate, DateTimeOffset endDate) args)
    {
        period = args.period;
        startDate = args.startDate;
        endDate = args.endDate;
        return Task.CompletedTask;
    }
    private Task HandleGraphDataChange()
    {
        return ScopeService.RunInScope<IHiveService>(async hiveService =>
        {
            await LoadAggregateData(hiveService);
            await InvokeAsync(StateHasChanged);
        });
    }
    private Task HandleTimeSeriesAdded()
    {
        return ScopeService.RunInScope<IHiveService>(async hiveService =>
        {
            await LoadLastData(hiveService);
            await InvokeAsync(StateHasChanged);
        });
    }

    private async Task LoadLastData(IHiveService hiveService)
    {
        _temperatureData = new List<(string name, TimeSeriesDataModel? data)>();
        _humidityData = new List<(string name, TimeSeriesDataModel? data)>();
        for (int i = 0; i < _hives.Count; ++i)
        {
            _humidityData.Add((_hives[i].Name, await hiveService.GetHiveLastData(_hives[i].Id, BeeHive.Domain.Data.TimeSeriesKind.Humidity)));
            _temperatureData.Add((_hives[i].Name, await hiveService.GetHiveLastData(_hives[i].Id, BeeHive.Domain.Data.TimeSeriesKind.Temperature)));
        }
    }

    private Task LoadAggregateData()
    {
        return LoadAggregateData(HiveService);
    }
    private async Task LoadAggregateData(IHiveService hiveService)
    {
        var hiveIds = _hives.Select(x => x.Id).ToArray();
        _temperatureAggregateData = await hiveService.GetHivesAggregateData(TimeSeriesKind.Temperature, period, hiveIds, startDate, endDate);
        _humidityAggregateData = await HiveService.GetHivesAggregateData(TimeSeriesKind.Humidity, period, hiveIds, startDate, endDate);
    }
}
