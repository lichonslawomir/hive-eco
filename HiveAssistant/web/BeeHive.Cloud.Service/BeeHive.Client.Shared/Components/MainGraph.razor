@using BeeHive.Client.Shared.Controls
@using BeeHive.Contract.Aggregate.Models
@using BeeHive.Contract.Data.Models
@using ChartJs.Blazor.Common
@using ChartJs.Blazor.Common.Handlers
@using ChartJs.Blazor.Interop

<div class="graphs-container" style="display: flex; gap: 2rem; flex-wrap: wrap;justify-content: center;">
    @foreach (var hive in _hives)
    {
        <VisibilitySwitch 
            Hive="hive"
            Visible="@(!_hiddenHives.Contains(hive.Id))"
            VisibleChanged="() => ToggleDatasetVisibility(hive.Id)" />
    }
</div>
<div class="graphs-container" style="display: flex; gap: 2rem; flex-wrap: wrap;">    
    <div style="flex: 1; min-width: 400px;">
        <h4>Temperature</h4>
        <div class="hidden-datasets-panel">
        </div>
        <Chart Config="temperatureLineChartConfig" @ref="_chartTemperature"></Chart>
        @foreach (var hive in TemperatureData)
        {
            <span>@hive.name: @(hive.data is null ? "???" : hive.data.Value.Value.ToString("F2")) (@(hive.data is null ? "" : hive.data.Value.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm")))</span>
            <br />
        }
    </div>
    <div style="flex: 1; min-width: 400px;">
        <h4>Humidity</h4>
        <Chart Config="humidityLineChartConfig" @ref="_chartHumidity"></Chart>
        @foreach (var hive in HumidityData)
        {
            <span>@hive.name: @(hive.data is null ? "???" : hive.data.Value.Value.ToString("P2")) (@(hive.data is null ? "" : hive.data.Value.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm")))</span>
            <br />
        }
    </div>
</div>


@code {
    [Parameter] public required IList<HiveDto> Hives { get => _hives; set { _agregateDataChange = true; _hives = value; } }

    [Parameter]
    public required IList<TimeAggregateSeriesHivesDataModel> TemperatureAggregateData
    {
        get => _temperatureAggregateData;
        set
        {
            _agregateDataChange = _temperatureAggregateData != value;
            _temperatureAggregateData = value;
        }
    }
    [Parameter]
    public required IList<TimeAggregateSeriesHivesDataModel> HumidityAggregateData
    {
        get => _humidityAggregateData;
        set
        {
            _agregateDataChange = _humidityAggregateData != value;
            _humidityAggregateData = value;
        }
    }

    [Parameter] public required IList<(string name, TimeSeriesDataModel? data)> TemperatureData { get; set; }
    [Parameter] public required IList<(string name, TimeSeriesDataModel? data)> HumidityData { get; set; }

    private IList<HiveDto> _hives = new List<HiveDto>();
    private IList<int> _hiddenHives = new List<int>();

    private IList<TimeAggregateSeriesHivesDataModel> _temperatureAggregateData = new List<TimeAggregateSeriesHivesDataModel>();
    private IList<TimeAggregateSeriesHivesDataModel> _humidityAggregateData = new List<TimeAggregateSeriesHivesDataModel>();

    private IList<(string name, TimeSeriesDataModel? data)> _temperatureData = new List<(string name, TimeSeriesDataModel? data)>();
    private IList<(string name, TimeSeriesDataModel? data)> _humidityData = new List<(string name, TimeSeriesDataModel? data)>();

    private bool _agregateDataChange = true;

    private Chart _chartTemperature = null!;
    private Chart _chartHumidity = null!;
    LineConfig temperatureLineChartConfig = new LineConfig()
    {
        Options = new LineOptions
        {
            Legend = new Legend
            {
                Display = false
            }
        }
    };
    LineConfig humidityLineChartConfig = new LineConfig()
    {
        Options = new LineOptions
        {
            Legend = new Legend
            {
                Display = false
            }
        }
    };

    protected override Task OnParametersSetAsync()
    {
        if (_agregateDataChange)
        {
            LoadGraphs();
            _agregateDataChange = false;
        }
        return Task.CompletedTask;
    }

    private void ToggleDatasetVisibility(int hiveId)
    {
        if (_hiddenHives.Contains(hiveId))
            _hiddenHives.Remove(hiveId);
        else
            _hiddenHives.Add(hiveId);

        LoadGraphs();
        _chartTemperature.Update();
        _chartHumidity.Update();
	}

    protected void LoadGraphs()
    {
        temperatureLineChartConfig.Data.Labels.Clear();
        temperatureLineChartConfig.Data.Datasets.Clear();
        var tt = TemperatureAggregateData;
        if (tt?.Any() == true)
        {
            var labels = tt.Select(dp => dp.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm")).ToArray();
            ((List<string>)temperatureLineChartConfig.Data.Labels).AddRange(labels);
            for (int i = 0; i < _hives.Count; ++i)
            {
                if(_hiddenHives.Contains(_hives[i].Id))
                    continue;

                temperatureLineChartConfig.Data.Datasets.Add(new ChartJs.Blazor.LineChart.LineDataset<float>(tt.Select(dp => dp.MaxValue[i] ?? float.NaN).ToList())
                {
                    Label = $"Max. {_hives[i].Name}",
                    Fill = ChartJs.Blazor.Common.Enums.FillingMode.Absolute(i * 3 + 1),
                    BorderColor = _hives[i].GraphColor.ToRgbaShadow()
                });
                temperatureLineChartConfig.Data.Datasets.Add(new ChartJs.Blazor.LineChart.LineDataset<float>(tt.Select(dp => dp.MinValue[i] ?? float.NaN).ToList())
                {
                    Label = $"Min. {_hives[i].Name}",
                    Fill = ChartJs.Blazor.Common.Enums.FillingMode.Absolute(i * 3),
                    BorderColor = _hives[i].GraphColor.ToRgbaShadow()
                });
                temperatureLineChartConfig.Data.Datasets.Add(new ChartJs.Blazor.LineChart.LineDataset<float>(tt.Select(dp => dp.AvgValue[i] ?? float.NaN).ToList())
                {
                    Label = $"Avg. {_hives[i].Name}",
                    Fill = false,
                    BorderColor = _hives[i].GraphColor.ToHexColor(),
                    
                });
            }
        }

        humidityLineChartConfig.Data.Labels.Clear();
        humidityLineChartConfig.Data.Datasets.Clear();
        var hh = HumidityAggregateData;
        if (hh?.Any() == true)
        {
            var labels = hh.Select(dp => dp.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm")).ToArray();
            //var labels = hh.Select(dp => dp.Timestamp.ToUniversalTime().ToString("O")).ToArray();
            //var localLabels = await JS.InvokeAsync<string[]>("formatDatesToLabels", labels, null);
            ((List<string>)humidityLineChartConfig.Data.Labels).AddRange(labels);
            for (int i = 0; i < _hives.Count; ++i)
            {
                if(_hiddenHives.Contains(_hives[i].Id))
                    continue;

                humidityLineChartConfig.Data.Datasets.Add(new ChartJs.Blazor.LineChart.LineDataset<float>(hh.Select(dp => dp.MaxValue[i] ?? float.NaN).ToList())
                {
                    Label = $"Max. {_hives[i].Name}",
                    Fill = ChartJs.Blazor.Common.Enums.FillingMode.Absolute(i * 3 + 1),
                    BorderColor = _hives[i].GraphColor.ToRgbaShadow()
                });
                humidityLineChartConfig.Data.Datasets.Add(new ChartJs.Blazor.LineChart.LineDataset<float>(hh.Select(dp => dp.MinValue[i] ?? float.NaN).ToList())
                {
                    Label = $"Min. {Hives[i].Name}",
                    Fill = ChartJs.Blazor.Common.Enums.FillingMode.Absolute(i * 3),
                    BorderColor = _hives[i].GraphColor.ToRgbaShadow()
                });
                humidityLineChartConfig.Data.Datasets.Add(new ChartJs.Blazor.LineChart.LineDataset<float>(hh.Select(dp => dp.AvgValue[i] ?? float.NaN).ToList())
                {
                    Label = $"Avg. {Hives[i].Name}",
                    Fill = false,
                    BorderColor = _hives[i].GraphColor.ToHexColor()
                });
            }
        }
    }
}
